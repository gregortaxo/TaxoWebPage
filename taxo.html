<!DOCTYPE html>
<html>
<title>Taxonomy</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta charset="UTF-8">
<link rel="stylesheet" href="w3.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
<script src="https://code.jquery.com/jquery-git2.js"></script>
<style>
.unselectable {
    -webkit-touch-callout: none;
    -webkit-user-select: none;
    -khtml-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
}
.testhover:hover {
    background-color: #7289da !important;
}
.testhoverGray:hover {
    background-color: #202225 !important;
}

* {
  box-sizing: border-box;
}

input {
  border-top: 1px solid transparent;
  border-right: 1px solid transparent;
  border-left: 1px solid transparent;
  border-bottom: 1px solid transparent;
  background-color: #202225;
  padding: 10px;
  font-size: 16px;
}
input:active,
input:focus {
	outline: none !important;
    border-color: #7289da;
    box-shadow: 0 0 5px #7289da;
}
input[type=text] {
  background-color: #202225;
  color: #fff;
  width: 100%;
}
input[type=password] {
  background-color: #202225;
  color: #fff;
  width: 100%;
}
button:active,
button:focus {
	outline: none !important;
    border-color: #7289da;
}
button{
	font-weight: bold; 
	font-size: 12px;
}
select{
	font-weight: bold; 
	font-size: 12px;
}
textarea {
  border: 1px solid transparent;
  background-color: #f1f1f1;
  padding: 10px;
  font-size: 16px;
}
textarea:active,
textarea:focus {
	outline: none !important;
    border-color: #d4d4d4;
    box-shadow: 0 0 5px #d4d4d4;
}

.autocomplete {
  /*the container must be positioned relative:*/
  position: relative;
  display: inline-block;
}
.autocomplete-items {
  position: absolute;
  border: 1px solid #4f545c;
  border-bottom: none;
  border-top: none;
  z-index: 99;
  /*position the autocomplete items to be the same width as the container:*/
  top: 100%;
  left: 0;
  right: 0;
}
.autocomplete-items div {
  padding: 10px;
  cursor: pointer;
  background-color: #fff; 
  border-bottom: 1px solid #d4d4d4; 
}
.autocomplete-items div:hover {
  /*when hovering an item:*/
  background-color: #e9e9e9; 
}
.autocomplete-active {
  /*when navigating through the items using the arrow keys:*/
  background-color: #ff9a7a !important; 
  color: #ffffff; 
}
.overlay{
    opacity:0.75;
    background-color:#36393f;
    position:fixed;
    width:100%;
    height:100%;
    top:0px;
    left:0px;
    z-index:2000;
	text-align: center;
}
.outer {
  height: 95vh;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}
.inner {
  flex: 1;
  overflow-y: scroll;
  scrollbar-width: thin;
  scrollbar-color: #202225 #36393f;
}

.tooltip {
  position: relative;
  /* display: inline-block; */
}

.tooltip .tooltiptext {
  visibility: hidden;
  min-width: 300px;
  background-color: #202225;
  color: #fff;
  text-align: center;
  border-radius: 6px;
  padding: 5px 5px;
  
  /* Position the tooltip */
  position: absolute;
  z-index: 1;
  top: 100%;
  left: 0%;
  margin-left: 0px;
}

.tooltip:hover .tooltiptext {
  visibility: visible !important; 
}

.tooltip .tooltiptextcenter {
  visibility: hidden;
  min-width: 300px;
  background-color: #202225;
  color: #fff;
  text-align: center;
  border-radius: 6px;
  padding: 5px 5px;
  
  /* Position the tooltip */
  position: absolute;
  z-index: 1;
  top: 100%;
  left: 50%;
  margin-left: -150px;
}

.tooltip:hover .tooltiptextcenter {
  visibility: visible !important; 
}

.tooltip .tooltiptextright {
  visibility: hidden;
  min-width: 300px;
  background-color: #202225;
  color: #fff;
  text-align: center;
  border-radius: 6px;
  padding: 5px 5px;
  
  /* Position the tooltip */
  position: absolute;
  z-index: 50000;
  top: 0%;
  left: 100%;
}

.tooltip:hover .tooltiptextright {
  visibility: visible !important; 
}

.parent { display: -ms-flex; display: -webkit-flex; display: flex; }
.parent>div { flex:1; }

ul, #myUL {
  list-style-type: none;
}

#myUL {
  margin: 0;
  padding: 0;
}

li {
  cursor: pointer;
}

li:hover { 
    color: #7289da ;
}

.caret {
  cursor: pointer;
  -webkit-user-select: none; /* Safari 3.1+ */
  -moz-user-select: none; /* Firefox 2+ */
  -ms-user-select: none; /* IE 10+ */
  user-select: none;
}

.caret::before {
  content: "+";
  font-weight: bold;
  color: #7289da ;
  display: inline-block;
  margin-right: 6px;
}

.caret-down::before {

  content: "-";  
}

.nested {
  display: none;
}

.active {
  display: block;
}

::-webkit-scrollbar {
  width: 10px;
}
::-webkit-scrollbar-track {
  background: #36393f; 
}
::-webkit-scrollbar-thumb {
  background: #202225;  
}
::-webkit-scrollbar-thumb:hover {
  background: #555; 
}

[hidden] {
    display: none !important;
}
</style>

<body style="background:#36393f" onload="setUpPage()" onresize="handleSize()" id="mainBody">

<!-- login -->
<section class="w3-container w3-center w3-content w3-card-2" style="background: #2f3136; position: absolute;  top: 50%; left: 50%;
					transform: translate(-50%, -50%);  text-align: center; width: 20cm; max-width: 75%;" id="loginCard">
  <h2 class="w3-wide unselectable w3-text-light-grey">Taxonomy</h2>
  <p class="w3-justify">
	<section class = "w3-center">
		<input class="w3-text-light-grey w3-round" type="text" id="UsernameInput" style="margin-bottom: 5px;" placeholder="Username" > 
		<input class="w3-text-light-grey w3-round" type="password" id="PassInput" placeholder="Password"> 
	</section>
	<p class="w3-text-light-grey" id="responseField" align="left" style="padding-left: 10px;"></p>
	<button class="w3-button w3-text-light-grey w3-round" onclick="logIn()" style="margin-bottom: 10px; background: #7289da;">Login</button>
	<button class="w3-button w3-text-light-grey w3-round" onclick="registerUser()" style="margin-bottom: 10px; background: #4f545c;">Register</button>
  </p>
  <br>
</section>

<div id="overlayDiv" class="overlay unselectable" hidden>
	<div style = "position: relative;  font-size: 32px; top: 50%; transform: translateY(-50%);" class="w3-text-white">Loading ...</div>
</div>

<div id="MenuDiv" hidden>
	<div id="overlayMenuDiv" style="opacity:0.75; background-color:#36393f;
	position:fixed; width:100%; height:100%; top:0px; left:0px; z-index:1000;" onclick="showMenu(0)"></div>

	<div id="contextMenu"class="w3-card-2 w3-rounded" 
	style="width: 20cm; position: absolute;  top: 50%; left: 50%; transform: translate(-50%, -50%); opacity:0.99; z-index: 1001; 
		padding: 10px; 	text-align: center; background: #2f3136;">
		<h4 class="w3-text-light-grey">New context</h4>
		<section class = "w3-center">
				<input class="w3-text-light-grey w3-round" type="text" id="newContextInput" placeholder="Context name" >  
		</section>
		<button class="w3-button w3-text-light-grey w3-round" onclick="addNewContext()" style="margin-bottom: 10px; margin-top: 10px; background: #4f545c; ">Add</button>
	</div>

	<div id="addNewQueryMenu" class="w3-card-2 w3-rounded" 	style="width: 20cm; position: absolute;  top: 50%; left: 50%;
		transform: translate(-50%, -50%); opacity:0.99; z-index: 1001; padding: 10px; text-align: center; background: #2f3136;">
		<h4 class="w3-text-light-grey">Add query to context</h4>
		<section class = "w3-center">
				<input class="w3-text-light-grey w3-round" type="text" id="newQueryNameInput" placeholder="Query name" >  
		</section>
		<button class="w3-button w3-text-light-grey w3-round" onclick="saveQueryToContext()" style="margin-bottom: 10px; margin-top: 10px; background: #4f545c; ">Add</button>
	</div>
	
	<div id="addNewBmMenu" class="w3-card-2 w3-rounded" style="width: 20cm; position: absolute;  top: 50%; left: 50%;
		transform: translate(-50%, -50%); opacity:0.99; z-index: 1001; padding: 10px; text-align: center; background: #2f3136;">
		<h4 class="w3-text-light-grey">Add bookmark</h4>
		<section class = "w3-center">
			<input class="w3-text-light-grey w3-round" type="text" placeholder="Enter bookmark name" id="newBmName" style="margin-bottom: 5px;" >
			<input class="w3-text-light-grey w3-round" type="text" placeholder="Enter URL" id="newBmUrl" style="margin-bottom: 5px;">
			<input class="w3-text-light-grey w3-round" id="fileToUpload" type="file" style="  background-color: #202225;color: #fff;width: 100%;"/>
		</section>
		<button class="w3-button w3-text-light-grey w3-round" style="margin-bottom: 10px; margin-top: 10px; background: #4f545c;" onclick="addBm()">Add</button>
	</div>

	<div id="connectBmToConceptMenu" class="w3-card-2 w3-rounded" style="width: 20cm; position: absolute;  top: 50%; left: 50%;
			transform: translate(-50%, -50%); opacity:0.99; z-index: 1001; padding: 10px; text-align: center; background: #2f3136;
			display: flex;  flex-direction: column; max-height: 75%;  overflow: hidden;">
			<h4 class="w3-text-light-grey">Add Concept To Bookmark</h4>
			<section class = "w3-center">
				<input class="w3-text-light-grey w3-round" type="text" placeholder="Enter Bookmark Name" id="addConToBmInput" onkeyup="filter()"> </input>
				<p>
					<button class="w3-button w3-text-light-grey w3-round" style="background: #4f545c;" onclick="addTag()">Add</button>
				</p>
			</section>
			<div style="flex: 1; overflow-y: scroll; scrollbar-width: thin; scrollbar-color: #202225 #36393f;"> 
				<ul id="bmListMenu" class="w3-text-light-grey" style="padding:0px;"></ul>
			</div>
	</div>

	<div id="infoBox" class="w3-card-2 w3-rounded" style="width: 20cm; position: absolute;  top: 50%; left: 50%;
	transform: translate(-50%, -50%); opacity:0.99; z-index: 1001; padding: 10px; text-align: center; background: #2f3136;">
		<h4 class="w3-text-light-grey" id="infoBoxText"></h4>
		<button class="w3-button w3-text-light-grey w3-round" style="margin-bottom: 10px; margin-top: 10px; background: #4f545c;" onclick="showMenu(0)">OK</button>
	</div>
</div>

<section class="w3-row-padding w3-center"  id="taxoSection" hidden>
	<section style="padding: 10px 0px; margin: 0px; width: 100%;z-index: 100" id="navigationHorizontal" hidden>
		<button class="w3-button w3-center w3-text-light-grey w3-round" style="background: #36393f;" id="SearchButton2"
			onclick="switchView(2)"><i class="material-icons" style="color:#f1f1f1; padding: 4px 0px 0px 0px;">search</i></button>
		<button class="w3-button w3-center w3-text-light-grey w3-round" style="background: #36393f;" id="NavigationButton2"
			onclick="switchView(1)"><i class="material-icons" style="color:#f1f1f1; padding: 3px 0px 0px 1px;">device_hub</i></button>
		<button class="w3-button w3-center w3-text-light-grey w3-round" style="background: #36393f;" id="BookmarkListButton2"
			onclick="switchView(3)"><i class="material-icons" style="color:#f1f1f1; padding: 4px 0px 0px 0px;">bookmarks</i></button>
			<button class="w3-button w3-center w3-text-light-grey w3-round" style="background: #36393f;" id="BookmarkTreeButton2"
			onclick="switchView(4)"><i class="material-icons" style="color:#f1f1f1; padding: 4px 0px 0px 0px;">account_tree</i></button>
			<button class="w3-button w3-center w3-text-light-grey w3-round" style="background: #36393f;" id="InfoButton2"
			onclick="switchView(5)"><i class="material-icons" style="color:#f1f1f1; padding: 4px 0px 0px 0px;">info</i></button>
	</section>

	<div class="parent">
		<section style="padding: 10px 0px; margin: 0px; width: 1%; max-width: 10%; z-index: 100" id="navigationVertical">
			<button class="w3-button w3-center w3-text-light-grey w3-round" style="background: #36393f;" id="SearchButton"
				onclick="switchView(2)"><i class="material-icons" style="color:#f1f1f1; padding: 4px 0px 0px 0px;">search</i></button>
			<button class="w3-button w3-center w3-text-light-grey w3-round" style="background: #36393f;" id="NavigationButton"
				onclick="switchView(1)"><i class="material-icons" style="color:#f1f1f1; padding: 3px 0px 0px 1px;">layers</i></button>
			<button class="w3-button w3-center w3-text-light-grey w3-round" style="background: #36393f;" id="BookmarkListButton"
				onclick="switchView(3)"><i class="material-icons" style="color:#f1f1f1; padding: 4px 0px 0px 0px;">bookmarks</i></button>
			<button class="w3-button w3-center w3-text-light-grey w3-round" style="background: #36393f;" id="BookmarkTreeButton"
				onclick="switchView(4)"><i class="material-icons" style="color:#f1f1f1; padding: 4px 0px 0px 0px;">account_tree</i></button>
			<button class="w3-button w3-center w3-text-light-grey w3-round" style="background: #36393f;" id="InfoButton"
				onclick="switchView(5)"><i class="material-icons" style="color:#f1f1f1; padding: 4px 0px 0px 0px;">info</i></button>
		</section>
				
		<div class="w3-container w3-center w3-content"  style="min-width: 90%; max-width: 90%; padding: 0px;" >
			<div id="searchSection" hidden>
				<div class="w3-half">
						<div id="taxoSearchCard" class="w3-container w3-center">
							<div class="outer">
								<h4 class="w3-wide unselectable w3-text-light-grey">Search</h4>
								<div class="w3-card-2 w3-round" style="padding: 5px 15px; margin: 5px; background: #2f3136;">
									<div class="parent"  style="width:100%; margin-top: 5px;">
											<section class = "w3-center" style="width: 78%">
												<form autocomplete="off" action="/action_page.php">
													<div class="autocomplete" style="width:100%;">
														<input class="w3-text-light-grey w3-round" type="text" placeholder="Enter bookmark name or taxonomy concept" id="BmSearchInput">
													</div>
												</form>
											</section>
											<div style="padding: 1px; width:20%; margin-left: 1%;">
												<button class="w3-button w3-text-light-grey w3-round w3-center" style=" width:100%; margin-top: 5px; background: #7289da"
														onclick="searchBms()">Find Bookmarks</button>
											</div>
									</div>
									<div class = "parent" style="margin: 10px 0px;">
										<select class="w3-button w3-round w3-text-light-grey" name="ChildrenDropdown" id="ChildrenDropdown" style="border: 0px; background: #4f545c; width: 30%;">
											<option value="1">With Children</option>
											<option value="2">Without Children</option>
										</select>
										<div class="tooltip w3-round w3-text-light-grey unselectable testhover" 
										style ="background: #4f545c; width: 20%; margin: 0px 5px;padding:8px 16px;vertical-align:middle;">
											<div>Help</div>
											<div class="tooltiptextcenter">
												<p>And search: a & b</p>
												<p>Or search: a | b</p>
												<p>Does not include: ! b</p>
												<p>Brackets: a & (b | c)</p>
											</div>
										</div>
										<button class="w3-button w3-text-light-grey w3-round w3-center" style="background: #4f545c; width: 30%;" onclick="showMenu(2)">Add To Context</button>
									</div>
									<div class="parent"  style="width:100%; margin-top: 10px; margin-bottom: 5px;">
											<section class = "w3-center" style="width: 78%">
												<form autocomplete="off" action="/action_page.php">
													<div class="autocomplete" style="width:100%;">
														<input class="w3-text-light-grey w3-round" type="text" placeholder="Enter taxonomy concept" id="ConceptSearchInput">
													</div>
												</form>
											</section>
											<div style="padding: 1px; width:20%; margin-left: 1%;">
												<button class="w3-button w3-text-light-grey w3-round w3-center" style=" width:100%; margin-top: 5px; background: #4f545c"
														onclick="searchTaxo()">Find Concepts</button>
											</div>
									</div>
								</div>
	
								<div class="inner">
									<div id="bmSearchCon"> </div>
									<div id="taxoSearchCon"> </div>
								</div>
							</div>
							<br>
						</div>
				</div>
				<article class="w3-half">
					<div class="w3-container w3-center">
						<div class="outer">
							<h4 class="w3-wide unselectable; w3-text-light-grey">Context</h4>
							<div class="inner">
									<div id="contextSection" style="margin-top: 5px;"></div>
							</div>
							<p class = "w3-center">
								<button class="w3-button w3-text-light-grey w3-round w3-center" style="background: #4f545c;" onclick="showMenu(1)" >Add new context</button>
								<select class="w3-button w3-round w3-text-light-grey" id="contextDropdown"  onchange="selectContext()" style="border: 0px; margin-left: 5px; background: #4f545c;"></select>
							</p>
						</div>						
					</div>
				</article>
			</div>
			<div id="taxoNavCard">
				<article class="w3-third">
					<h4 class="unselectable w3-text-light-grey w3-wide ">Parents</h4>
					<div id="taxoNavConParents" style="margin-top: 15px"> </div>
				</article>
	
				<article class="w3-third">
					<h4 class="unselectable w3-text-light-grey w3-wide ">Word</h4>
					<div style="margin-left: 15px; margin-right: 15px; margin-top: 15px">
						<div id="taxoNavConWord"> </div>
						<button class="w3-button w3-text-light-grey w3-round" style="background: #4f545c; margin-top: 10px; margin-bottom: 15px;"  
								onclick="showMenu(5)">Add To Bookmark</button>
						<div id="ConnectedThings" class="w3-container w3-center w3-content w3-card-2" style="background: #36393f;" hidden>
							<h4 class="w3-text-light-grey" style="margin: 2px">Bookmarks</h4>
							<div id="ConnectedThingsCon" style="padding-bottom: 10px;"></div>
						</div>
					</div>
				</article>
	
				<article class="w3-third">
					<h4 class="unselectable w3-text-light-grey w3-wide ">Children</h4>
					<div style="overflow: auto; max-height: 90vh">
						<div id="taxoNavConChildren"> </div>
					</div>
				</article>
			</div>
			<div id="bmSectionWrap" hidden>
				<article class="w3-twothird" >
					<div id="bmDetails">
						<div id="BmDetCard" class="w3-container w3-center w3-content"> 
							<div class="outer">
								<div class="inner">
									<h4 class="w3-wide unselectable w3-center w3-round w3-text-light-grey">Bookmark Details</h4>
									<div id="bmDetCon"></div>
									<div id="filePreviewDiv" class="w3-round w3-card-2" style="margin: 15px 7px; padding-top: 5px; padding-bottom: 10px; background: #2f3136;">
										<h5 class="w3-text-light-grey" style="margin: 0px; padding: 0px; font-weight: bold;">File Preview</h5>
										<img id= "imagePreview" width="250" style="display: block; margin-left: auto; margin-right: auto; margin-top: 5px;"></img>
										<div class="w3-text-light-grey" style="margin: 0px; padding-left: 5px; padding-right: 5px;" id= "textPreview"></div>
									</div>
									<div id="similarBmsDiv" class="w3-round w3-card-2" style="margin: 15px 7px; padding-top: 5px; padding-bottom: 5px; background: #2f3136;">
										<h5 class="w3-text-light-grey" style="margin: 0px; padding: 0px; font-weight: bold;">Related Bookmarks</h5>
										<div id= "similarBmsCon"></div>
									</div>
								</div>
							</div> 
						</div>
					</div>
				</article>
				<article class="w3-third">
					<div id="bmSection">
						<div id="userBmsCard" class="w3-container w3-center w3-content"> 
							<div class="outer w3-center">
								<h4 class="w3-wide unselectable w3-center w3-text-light-grey">User Bookmarks</h4>
								<div class="w3-center">
									<button class="w3-button w3-text-light-grey w3-round" onclick="showMenu(3)"
										style="background: #4f545c; margin-bottom: 10px;">Add Bookmark</button>
										<button class="w3-button w3-text-light-grey w3-round" onclick="switchView(4)"
										style="background: #4f545c; margin-bottom: 10px;">Tree</button>
								</div>
								<div id="bmsCon" class="inner"> </div>
							</div> 
						</div>
					</div>
				</article>
			</div>
			<div id="bmTreeView" hidden>
				<h4 class="w3-wide unselectable; w3-text-light-grey">Bookmark Tree</h4>
				<div  style="max-width: 1000px;  margin: auto;"  >
					<ul id="myUL" style="text-align: left;"></ul>
				</div>
			</div>
			<div id="infoView" hidden>
				<h4 class="w3-wide unselectable w3-text-light-grey">Account</h4>
				<div class="w3-card-2 w3-round parent" style="max-width: 1000px;  margin: auto; padding: 5px 15px; background: #2f3136;">
					<div>
						<div align="left" style="color: #747880; font-weight: bold; ">Username</div> 
						<div align="left" class = "w3-text-light-grey" id="userNameLabel"></div>
						<div align="left" style="color: #747880; font-weight: bold; ">Number Of User Bookmarks</div> 
						<div align="left" class = "w3-text-light-grey" id="numOfBmLabel"></div>
					</div>
					<button align="right" class="w3-button w3-text-light-grey w3-round" onclick="reloadPage()" style="background: #7289da; height: 32px;">Log Out</button>
				</div>
			</div>
		</div>
	</div>
</section>
<div id="xsstest"></div>

<script src="FileSaver.js"></script>
<script>
//#region variables
//var serverAddress = "https://www.studenti.famnit.upr.si/~89141014/PHPfolder/taxoForward.php";
//var taxoIndexAddress = "https://www.studenti.famnit.upr.si/~89141014/PHPfolder/taxoIndex.txt";

// var serverAddress = "http://89.143.68.172/taxoForwardLocal.php";
// var taxoIndexAddress = "http://89.143.68.172/taxoIndex.txt";

// var serverAddress = "http://192.168.1.11/taxoForwardLocal.php";
// var taxoIndexAddress = "http://192.168.1.11/taxoIndex.txt";

var serverAddress = "http://localhost/taxoForwardLocal.php";
var taxoIndexAddress = "http://localhost/taxoIndex.txt";

var windowWidth = window.outerWidth;

var currUsername, currPassword, currTaxoId, currTaxoName;

var userBookmarks = [], bmsDict = {}, currBookmarks = [], taxoIndex = [], currentDetails = "";

var taxoCache = {}, taxoCacheLoaded = {}, imagePreviewCache = {}, similarBmsCache = {};

var contexts = [], currentContext = 0;

var sendInChunksbookmark = "", sendInChunksdataToSend = "", sendInChunksiter = "";

var firstLoadDoNotShowTaxoNav = true, bmTreeNeedsUpdate = true;

var darkestShadeColor = "#202225", darkerShadeColor = "#2f3136", backgroundColor = "#36393f",
    buttonColor = "#4f545c", blueAccentColor = "#7289da", greenAccentColor = "#43b582";

var ul = getById("bmListMenu");

var views = [getById("taxoNavCard"),getById("searchSection"),getById("bmSectionWrap"),getById("bmTreeView"),getById("infoView")];

var buttons = [getById("NavigationButton"),getById("SearchButton"),getById("BookmarkListButton"),getById("BookmarkTreeButton"),getById("InfoButton")];

var menus = [getById("contextMenu"),getById("addNewQueryMenu"),getById("addNewBmMenu"),getById("infoBox"),getById("connectBmToConceptMenu")];
//#endregion

//#region page navigation & setup
function showLoadingOverlay(value){
	getById("overlayDiv").hidden = !value;
}

function setUpPage(){
	navigationBarResize();
	loadTaxoIndex();

	addEnterKeyListener("newBmName", addBm);
	addEnterKeyListener("newBmUrl", addBm);
	//addEnterKeyListener("ConceptSearchInput", searchTaxo);
	//addEnterKeyListener("BmSearchInput", searchBms);
	addEnterKeyListener("newQueryNameInput", saveQueryToContext);
	addEnterKeyListener("newContextInput", addNewContext);
	addEnterKeyListener("PassInput", logIn);
	addEnterKeyListener("addConToBmInput", addTag);

	ul.onclick = function(event) {
		var target = getEventTarget(event);
		getById("addConToBmInput").value = target.innerHTML;
		filter();
	};
}

function addEnterKeyListener(element, enterKeyCallback){
	getById(element).addEventListener("keyup", function(event) {
	  event.preventDefault();
	  if (event.keyCode === 13) {
		enterKeyCallback();
	  }
	});
}

function handleSize(){
	windowWidth = window.outerWidth;
	navigationBarResize();
}

function navigationBarResize(){
	if(windowWidth < 800){
		getById("navigationVertical").hidden = true;
		getById("navigationHorizontal").hidden = false;
	}
	else{
		getById("navigationVertical").hidden = false;
		getById("navigationHorizontal").hidden = true;
	}
}

function loadTaxoIndex() {
  var xhttp = new XMLHttpRequest();
  xhttp.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
     	taxoIndex = this.responseText.split('\n');
	 	autocomplete(getById("ConceptSearchInput"), taxoIndex, searchTaxo);
		autocomplete(getById("BmSearchInput"), taxoIndex, searchBms);
    }
  };
  xhttp.open("GET", taxoIndexAddress, true);
  xhttp.send();
}

async function loggedIn(){
	switchView(2);

	getById("userNameLabel").textContent = currUsername;

	updateNavigation(event,"00001740");
	await getBms();
	await getContexts(0);
	
	getById("taxoSection").hidden = false;
	getById("loginCard").hidden = true;
}

function switchView(view){
	for(var i = 0; i < views.length; i++){
		if(i == view - 1){
			views[i].hidden = false;
			buttons[i].style.background = blueAccentColor;

			if(i == 3){	showTreeView() }
		}
		else{
			views[i].hidden = true;
			buttons[i].style.background = backgroundColor;
		}
	}
}

function showMenu(menu){
	var menuDiv = getById("MenuDiv");

	if(menu == 0){
		getById("infoBoxText").textContent = "";
		menuDiv.hidden = true;
		return;	
	}
	else{
		menuDiv.hidden = false;
	}
	
	for(var i = 0; i < menus.length; i++){
		var menuNum = menu - 1;
		if(i == menuNum){
			menus[i].hidden = false;
		}
		else{
			menus[i].hidden = true;
		}

		if(menuNum == 0){
			getById("newContextInput").focus();
		}
		else if(menuNum == 1){
			getById("newQueryNameInput").focus();
		}
		else if(menuNum == 2){
			getById("newBmName").focus();
		}
		else if(menuNum == 4){
			getById("addConToBmInput").focus();
		}
	}
}

function showMessage(message){
	getById("infoBoxText").textContent = message;
	showMenu(4);
}

function logIn(){
	currUsername = getById("UsernameInput").value;
	currPassword = getById("PassInput").value;
	
	var message = { fun: "login", username: escape(currUsername), password: escape(currPassword) };

	makeAjaxCall(JSON.stringify(message)).then(function(result) 
	{
		if(result == ""){ showMessage("Connection error. Please try again"); return; }

		var myObj = JSON.parse(result);
		getById("responseField").textContent = myObj.result;
		
		if(myObj.result == "success"){
			loggedIn();
		}
	});
}

function registerUser(){
	var message = { fun: "regUser", username: escape(getById("UsernameInput").value), password: escape(getById("PassInput").value) };
	
	makeAjaxCall(JSON.stringify(message)).then(function(result) 
	{
		if(result == ""){ showMessage("Connection error. Please try again"); return; }

		var myObj = JSON.parse(result);
		getById("responseField").textContent = myObj.result;
	});
}
//#endregion

//#region taxo navigation
function updateNavigation(ev,taxoWord){
	if(ev != undefined){
		ev.stopPropagation();
	}

	showLoadingOverlay(true);

	var taxoCached = false;
	
	if(	taxoCacheLoaded[taxoWord] != undefined){
		taxoCached = true;
	}

	var taxoCachedPartially = false;

	if(taxoCache[taxoWord] != undefined){
		addNavResults(taxoCache[taxoWord]);
		switchView(1);

		if(taxoCached){	return;	}

		taxoCachedPartially = true;
	}

	var message = { fun: "searchTaxo", username: escape(currUsername), password: escape(currPassword), word: taxoWord };

	makeAjaxCall(JSON.stringify(message)).then(function(result) 
	{
		if(result == ""){ showMessage("Connection error. Please try again"); showLoadingOverlay(false); return; }

		var myObj = JSON.parse(result);

		for(var j = 0; j < myObj.result.length; j++){
			taxoCache[myObj.result[j][0][1][0]] = myObj.result[j];
		}

		taxoCacheLoaded[taxoWord] = true;

		if(taxoCachedPartially == false){
			addNavResults(taxoCache[taxoWord]);

			if(firstLoadDoNotShowTaxoNav == false){
				switchView(1);
			}
			firstLoadDoNotShowTaxoNav = false;
		}
	});
}

function addNavResults(results){
	for(var j = 0; j < results.length; j++){
	
		var myNode;
		var connectedThings;
		
		if(j == 0){
			myNode = getById("taxoNavConWord"); 
			connectedThings = getById("ConnectedThings"); 	
		}
		else if(j == 1){
			myNode = getById("taxoNavConParents");
		}
		else{
			myNode = getById("taxoNavConChildren");
		}
		
		removeChildren(myNode);
		
		if(results[j][1].length <= 0){
			continue;
		}

		var countTmp;
		
		if(j == 0){ countTmp = 1; }
		else{ countTmp = results[j][1].length; }
		
		for (var i = 0; i < countTmp ; i++) { 
			var tmpResult
			
			if(j == 0)
			{
				tmpResult = results[j][1]; 
				currTaxoId = tmpResult[0];
				currTaxoName = tmpResult[1];
			}
			else { tmpResult= results[j][1][i]; }
			
			if (tmpResult[1] == undefined){
				break;
			}
			
			var card = makeDiv("div", ["w3-card-2","w3-round"], "7px 5px", "0px", darkerShadeColor);
			var header = makeDiv("header", ["w3-container"]);
			var h1 = makeDiv("h5",["w3-text-light-grey", "w3-text-black"],"5px 0px");
			h1.appendChild(document.createTextNode(tmpResult[1].replace(/,/g, ", ")));
			header.appendChild(h1);
			card.appendChild(header);		

			if(j != 0) {
				card.classList.add("testhover");
				card.setAttribute("onclick","updateNavigation(event,'"+tmpResult[0]+"')");
				header.classList.add("unselectable");
			}
			else {
				card.style.background = blueAccentColor;
				card.style.paddingBottom = "10px";
			}			
			
			if(j == 0){
				var textDiv = makeDiv("div");
				var para = makeDiv("p",["w3-text-light-grey"],"5px");
				para.appendChild(document.createTextNode(tmpResult[3]));
				textDiv.appendChild(para);
				card.appendChild(textDiv);

				if(bmsDict[currTaxoId] != undefined){
					var connectedBmsCon = getById("ConnectedThingsCon");
					removeChildren(connectedBmsCon);

					for(var y = 0; y < bmsDict[currTaxoId].length; y++){		
						var connectedBm = makeDiv("h5", ["unselectable","testhover","w3-text-light-grey","w3-round"],"5px",undefined,backgroundColor);
						connectedBm.appendChild(document.createTextNode(bmsDict[currTaxoId][y]));
						connectedBm.setAttribute("onclick","showBmDetails('"+bmsDict[currTaxoId][y]+"',true)");
						connectedBmsCon.appendChild(connectedBm);
					}
					
					connectedThings.hidden = false;
				}
				else{
					connectedThings.hidden = true;
				}
			}

			myNode.appendChild(card);
		}
	}
	showLoadingOverlay(false);
}
//#endregion

//#region taxo search
function searchTaxo(){
	showLoadingOverlay(true);
	
	var currSearchWord = getById("ConceptSearchInput").value.toLowerCase().trim();
	var contextConcepts = "";
	
	if(contexts.length > 0){
		var count = contexts[currentContext][1].length;
		for(var i = 0; i < count; i++){
			contextConcepts += contexts[currentContext][1][i][0]

			if(i < (count-1)){
				contextConcepts += ",";
			}
		}
	}
	
	var message = { fun: "findTaxo", username: escape(currUsername), password: escape(currPassword), word: escape(currSearchWord), contextConcepts: escape(contextConcepts) };

	makeAjaxCall(JSON.stringify(message)).then(function(result) 
	{
		if(result == ""){ showMessage("Connection error. Please try again"); showLoadingOverlay(false); return; }

		var myObj = JSON.parse(result);
		
		showLoadingOverlay(false);
		addSearchResults(myObj.result);
	});
}

function addSearchResults(results){
	var myNode = getById("taxoSearchCon");
	removeChildren(myNode);

	var bmsNode = getById("bmSearchCon");
	removeChildren(bmsNode);

	var resultsLength = 0;

	if(results != undefined){
		resultsLength =  results.length;
	}
	
	var resNode = makeDiv("h5",["w3-text-light-grey"]);
	resNode.appendChild(document.createTextNode("Taxonomy search: " + resultsLength + " results"))
	myNode.appendChild(resNode);
		
	if(resultsLength <= 0){
		return;
	}

	for (var i = 0; i < results.length; i++) { 
		var card = makeDiv("div", ["w3-card-2","w3-round","parent","testhoverGray"],"7px","3px",buttonColor);

		var titleSplit = results[i][1].split(",");
		var tmp = "addToSearchField('"+titleSplit[0]+"','"+results[i][0]+"')";
		card.setAttribute("onclick",tmp);

		var hoverArea = makeDiv("div", ["w3-center","w3-round","tooltip","testhover"], undefined, "5px", darkerShadeColor, "10%");
		card.appendChild(hoverArea);

		var header = makeDiv("header", ["unselectable","w3-text-light-grey"], undefined, "2px 10px", undefined, "90%");
		header.appendChild(document.createTextNode(results[i][1].replace(/,/g, ", ")));
		card.appendChild(header);

		var tooltiptextSpanHeader = document.createElement("div");
		tooltiptextSpanHeader.textContent = results[i][1];
		tooltiptextSpanHeader.style = "font-weight: bold";
		tooltiptextSpanHeader.style.marginBottom = "5px";

		var tooltiptextSpan = document.createElement("span");
		tooltiptextSpan.textContent = results[i][3];

		var tooltiptextDiv = makeDiv("div",["tooltiptextright"]);
		tooltiptextDiv.appendChild(tooltiptextSpanHeader);
		tooltiptextDiv.appendChild(tooltiptextSpan);
		hoverArea.appendChild(tooltiptextDiv);

		var butPara = document.createElement("p");
		butPara.appendChild(makeButton("Open", "updateNavigation(event,'"+results[i][0]+"')", buttonColor, "0px 0px 0px 5px"));
		butPara.appendChild(makeButton("Add to context", "addTaxoTagToContext(event,'"+results[i][0]+"','"+results[i][1]+"')", greenAccentColor, "0px 0px 0px 5px"));

		tooltiptextDiv.appendChild(butPara);

		myNode.appendChild(card);
	}	
}
//#endregion

//#region bookmark search
function searchBms(){
	showLoadingOverlay(true);
	var query = getById("BmSearchInput").value.toLowerCase().trim();

	if(query == ""){
		if(contexts.length > 0)
		{
			var count = contexts[currentContext][1].length;
			for(var i = 0; i < count; i++){
				query += "["+contexts[currentContext][1][i][1].split(",")[0]+","+contexts[currentContext][1][i][0]+"]"

				if(i < (count-1)){
					query += " | ";
				}
			}
			getById("BmSearchInput").value = query;
		}
	}

	var childrenDrop = getById("ChildrenDropdown").value;
	var childrenValue = "False";
	
	if(childrenDrop == "1"){
		childrenValue = "True";
	}
	
	var message = { fun: "newSearch", username: escape(currUsername), password: escape(currPassword), query: escape(query), children: childrenValue };
	
	makeAjaxCall(JSON.stringify(message)).then(function(result) 
	{
		if(result == ""){ showMessage("Connection error. Please try again"); showLoadingOverlay(false); return; }

		var myObj = JSON.parse(result);
		
		addBmSearchResults([]);
		addBmSearchResults(myObj.result);
		showLoadingOverlay(false);
	});
}

function addBmSearchResults(bms){
	var myNode = getById("bmSearchCon");
	removeChildren(myNode);

	var taxoNode = getById("taxoSearchCon");
	removeChildren(taxoNode);

	var bmsLength = 0;

	if(bms != undefined){
		bmsLength = bms.length; 
	}
	
	var resNode = makeDiv("h5",["w3-text-light-grey"]);
	resNode.appendChild(document.createTextNode("Bookmark search: " + bmsLength + " results"));
	myNode.appendChild(resNode);
	
	if(bmsLength > 0){
		for (var i = 0; i < bms.length; i++) { 
			var card = makeDiv("div", ["w3-card-2","w3-round","testhover"], "5px", undefined, darkestShadeColor);

			var header = makeDiv("header",["w3-text-light-grey","w3-container","unselectable"]);
			var h1 = makeDiv("h5",["w3-text-light-grey"],"5px");
			h1.appendChild(document.createTextNode(bms[i][0]));
			header.appendChild(h1);

			card.appendChild(header);
			card.setAttribute("onclick","showBmDetails('"+bms[i][0]+"',true)");
			myNode.appendChild(card);
		}
	}		
}
//#endregion

//#region bookmarks
function getBms(){
	var message = { fun: "getUserBookmarks", username: escape(currUsername), password: escape(currPassword) };

	makeAjaxCall(JSON.stringify(message)).then(function(result) 
	{
		if(result == ""){ showMessage("Connection error. Please try again"); return; }

		var myObj = JSON.parse(result);
		bmsDict = {};
		userBookmarks = myObj.result;
		
		for(var i = 0; i< userBookmarks.length; i++){
			for(var j = 0; j< userBookmarks[i][2].length; j++){
				if(bmsDict[userBookmarks[i][2][j][1]] == undefined){
					bmsDict[userBookmarks[i][2][j][1]] = [userBookmarks[i][0]];
				}
				else{
					bmsDict[userBookmarks[i][2][j][1]].push(userBookmarks[i][0]);
				}		
			}	
		}

		if(currentDetails == "" && userBookmarks.length > 0){
			showBmDetails(userBookmarks[0][0],false);
		}
		else{
			showBmDetails(currentDetails,false);
		}

		addUserBms(myObj.result);
		return 1;
	});
}

function addUserBms(bms){
	//add tag to bm list
	currBookmarks = [];

	if(bms.length > 0){
		for (var i = 0; i < bms.length; i++) { 
			currBookmarks.push(bms[i][0]);
		}
	}

	var list = getById("bmListMenu");
	removeChildren(list);

	for (var i = 0; i <  bms.length; i++) {
		var item = document.createElement('li');
		item.appendChild(document.createTextNode(bms[i][0]));
		list.appendChild(item);
	}

	//user bm list
	var myNode = getById("bmsCon");
	removeChildren(myNode);
	getById("numOfBmLabel").textContent = bms.length;
	
	if(bms.length > 0){
		for (var i = 0; i < bms.length; i++) { 
				var card = makeDiv("div", ["w3-card-2","w3-round","testhover"], "7px", "5px",darkerShadeColor);
				var header = makeDiv("header", ["w3-text-light-grey","w3-container","unselectable"]);
				var h1 = makeDiv("h5",undefined,"0px","0px");
				var nodeDiv = makeDiv("div",["w3-text-light-grey"]);	

				nodeDiv.appendChild(document.createTextNode(bms[i][0]));
				h1.appendChild(nodeDiv);
				header.appendChild(h1);
				card.appendChild(header);
				card.setAttribute("onclick","showBmDetails('"+bms[i][0]+"',true)");
				myNode.appendChild(card);
		}
	}		
}

function filter() {
        var value = getById("addConToBmInput").value;
        $("#bmListMenu > li").each(function() {
            if ($(this).text().search(value) > -1) {
                $(this).show();
            }
            else {
                $(this).hide();
            }
        });
    }

function getEventTarget(e) {
	e = e || window.event;
	return e.target || e.srcElement; 
}

function showBmDetails(bookmark, showDetails){
	currentDetails = bookmark;

	var bm;
	for(var i = 0; i < userBookmarks.length; i++){
		if(userBookmarks[i][0] == bookmark){
			bm = userBookmarks[i];
			break;
		}
	}

	var myNode = getById("bmDetCon");
	removeChildren(myNode);

	if(bm == undefined){
		return;
	};

	var card = makeDiv("div", ["w3-card-2","w3-round"], "7px", "5px", darkerShadeColor);
	var header = makeDiv("header",["unselectable", "w3-text-light-grey","w3-container"]);
	var nodeDiv = makeDiv("h4",["w3-text-light-grey"], "0px");					
	nodeDiv.appendChild(document.createTextNode(bm[0]));
	header.appendChild(nodeDiv);
	card.appendChild(header);

	var a = document.createElement("a");
	var aDiv = document.createElement("div");
	aDiv.textContent = bm[1];
	a.style.color = blueAccentColor;
	a.target="_blank"
	aDiv.style = "width: 100%; text-overflow: ellipsis; white-space: nowrap;overflow: hidden; margin-bottom: 5px;";
	a.appendChild(aDiv);

	if(bm[1].includes("http://")|| bm[1].includes("https://")){
		a.href = bm[1];
	}
	else{
		a.href = "//" + bm[1];
	}

	card.appendChild(a);
	card.appendChild(makeButton("Download", "getBookmarkFile('"+bm[0]+"')", blueAccentColor, "5px 5px 0px 0px"));
	card.appendChild(makeButton("Delete", "removeBookmark('"+bm[0]+"')", buttonColor, "5px 5px 0px 0px"));	

	var connectedConcepts = makeDiv("div",undefined,undefined,"0px");

	if(bm[2].length > 0)
	{
		var spaceDiv = document.createElement("div");
		spaceDiv.style.height = "8px";
		card.appendChild(spaceDiv);
		
		for (var j = 0; j < bm[2].length; j++) { 
			var connectedConcept = makeDiv("div", ["w3-card-2","w3-round","unselectable","testhoverGray","w3-text-light-grey"], "10px", "3px", buttonColor);
			connectedConcept.setAttribute("onclick","updateNavigation(event,'"+bm[2][j][1]+"')");
			connectedConcept.appendChild(document.createTextNode(bm[2][j][0].replace(/,/g, ", ")));
			connectedConcepts.appendChild(connectedConcept);
		}
	}

	card.appendChild(connectedConcepts);
	myNode.appendChild(card);

	if(showDetails){
		switchView(3);
	}

	var image = getById('imagePreview');
	image.removeAttribute('src');
	
	getById("similarBmsDiv").hidden = true;

	loadFilePreview(bm[0]);
	loadSimilarBms(bm[0]);
}

function loadFilePreview(bookmark){
	if(imagePreviewCache[bookmark] != undefined)
	{
		showFilePreview(bookmark)
	}
	else
	{
		var message = { fun: "getFilePreview", username: escape(currUsername), password: escape(currPassword), bookmark: escape(bookmark)};

		makeAjaxCall(JSON.stringify(message)).then(function(result) 
		{
			if(result == ""){ showMessage("Connection error. Please try again"); return; }

			var myObj = JSON.parse(result);

			if(myObj.result == "" || myObj.result == "undefined")
			{
				imagePreviewCache[bookmark] = "";
			}
			else
			{
				if(myObj.result.startsWith("data:image"))
				{
					var base64HeadAndBody = myObj.result.split(";base64,");
					var abc = base64HeadAndBody[1].replace(/-/g,"+");
					var cba = base64HeadAndBody[0] + ";base64," + abc;

					imagePreviewCache[bookmark] = cba;
				}
				else{
					imagePreviewCache[bookmark] = myObj.result;
				}
			}

			if(currentDetails == bookmark)
			{
				showFilePreview(bookmark)
			}
		});
	}
}

function showFilePreview(bookmark){
		var image = getById('imagePreview');
		var textPreview = getById('textPreview');
		var filePreviewDiv = getById('filePreviewDiv');
		if(imagePreviewCache[bookmark] == "")
		{
			image.removeAttribute('src');
			textPreview.textContent = "";
			filePreviewDiv.hidden = true;
			return;
		}
		else if(imagePreviewCache[bookmark].startsWith("data:image"))
		{
			textPreview.textContent = "";
			image.src = imagePreviewCache[bookmark];
			filePreviewDiv.hidden = false;
		}
		else{
			image.removeAttribute('src');
			textPreview.textContent = window.atob(imagePreviewCache[bookmark]);
			filePreviewDiv.hidden = false;
		}
}

function loadSimilarBms(bookmark){
	if(similarBmsCache[bookmark] != undefined)
	{
		addSimilarBms(similarBmsCache[bookmark]);
	}
	else
	{
		var message2 = { fun: "getSimilarBms", username: escape(currUsername), password: escape(currPassword), bookmark: escape(bookmark)};

		makeAjaxCall(JSON.stringify(message2)).then(function(result) 
		{
			if(result == ""){ showMessage("Connection error. Please try again"); return; }

			var myObj = JSON.parse(result);

			similarBmsCache[bookmark] = myObj.result;

			addSimilarBms(myObj.result);
		});
	}
}

function addSimilarBms(bms){
	var myNode = getById("similarBmsCon");
	removeChildren(myNode);

	var simBmsDiv = getById("similarBmsDiv");

	if(bms.length == 0){
		simBmsDiv.hidden = true;
	}
	else{
		simBmsDiv.hidden = false;
	}

	for (var i = 0; i < bms.length; i++) { 
		var card = makeDiv("div", ["w3-card-2","w3-round","testhover"], "5px 15px", undefined, darkestShadeColor);
		var header = makeDiv("header", ["w3-text-light-grey","w3-container","unselectable"]);
		var h1 = makeDiv("h5",["w3-text-light-grey"], "5px");

		h1.appendChild(document.createTextNode(bms[i]));
		header.appendChild(h1);
		card.appendChild(header);
		card.setAttribute("onclick","showBmDetails('"+bms[i]+"',true)");
		myNode.appendChild(card);
	}	
}

function addBm(){
	showLoadingOverlay(true);

	var files = getById('fileToUpload').files;
	var fileName = "";
	var fileData = "";
	var fileSize = 0;

  	if (files.length > 0) {
    	var fileToSave = files[0];
		getById('fileToUpload').value = null;

		if(fileToSave.size > 50000000){
			showMessage("File size exceeds 50MB, please select a smaller file");
			showLoadingOverlay(false);
    		return;
		}

		fileName = fileToSave.name;
		fileSize = fileToSave.size;	
		
		var promise = getBase64(fileToSave);
			promise.then(function(result) {
				fileData = result;

				if(fileData == "data:")
				{
					addBmCont("","",0,"");
					return;
				}

				var base64HeadAndBody = fileData.split(";base64,");
				var abc = base64HeadAndBody[1].replace(/\+/g,"-");
				var cba = base64HeadAndBody[0] + ";base64," + abc;
				
				if(fileData.startsWith("data:image"))
				{	
					var image = new Image();
					image.onload = function()
					{
						var canvas = document.createElement('canvas');
						var ctx = canvas.getContext('2d');
						canvas.width = 200;
						canvas.height = canvas.width * (image.height / image.width);
						ctx.drawImage(image, 0, 0, canvas.width, canvas.height);

						var data = canvas.toDataURL();

						imagePreviewCache[getById("newBmName").value] = data;

						image.onload = function(){};

						var previewbase64HeadAndBody = data.split(";base64,");
						var previewAbc = previewbase64HeadAndBody[1].replace(/\+/g,"-");
						var previewCba = previewbase64HeadAndBody[0] + ";base64," + previewAbc;

						addBmCont(fileName,cba,fileSize,previewCba);
					}

					image.src = fileData;
				}
				else if(fileData.startsWith("data:text"))
				{	
					var text = window.atob(base64HeadAndBody[1]);

					if(text.length > 2000){
						text = text.substring(0, 2000);
					}

					var encodedText = window.btoa(text);

					imagePreviewCache[getById("newBmName").value] = encodedText;
					addBmCont(fileName,cba,fileSize,encodedText);
				}
				else
				{
					addBmCont(fileName,cba,fileSize,"");
				}
		});
  	}
	else{
		addBmCont("","",0,"");
	}
}

function addBmCont(fileName, fileData,fileSize,imagePreview){
	var newBmName = escape(getById("newBmName").value);
	var newBmUrl = escape(getById("newBmUrl").value);

	if(newBmName == ""){
		showLoadingOverlay(false);
		showMessage("Bookmark name cannot be empty");
		return;
	}

	var dataToSend = [fileData];

	var chunksize = 5000000;

	if(fileSize > chunksize){
		var chunks = Math.floor((fileSize + chunksize) /chunksize)
		dataToSend = chunkArray(fileData,chunks);
	}
	
	var message = { fun: "addTaxoBm", username: escape(currUsername), password: escape(currPassword), name: newBmName, url: newBmUrl,
					 filename: escape(fileName), filedata: escape(dataToSend[0]), filepreview: escape(imagePreview)};

	makeAjaxCall(JSON.stringify(message)).then(function(result) 
	{
		if(result == ""){ showMessage("Connection error. Please try again"); showLoadingOverlay(false); return; }

		var myObj = JSON.parse(result);

		if(myObj.result == "bookmark_already_exists"){
			showLoadingOverlay(false);
			showMessage("Bookmark with this name already exists");
		}
		else if(myObj.result == "bookmark_added"){					
			if(dataToSend.length > 1){
				showLoadingOverlay(true);
				sendInChunksbookmark = newBmName;
				sendInChunksdataToSend = dataToSend;
				sendInChunksiter = 1;
				sendRestOfData();
			}
			else{
				showMessage("Bookmark was successfully saved");
				showLoadingOverlay(false);
				getBms();
			}
		}
	});
}

function sendRestOfData(){
	var bookmark = sendInChunksbookmark;
	var dataToSend = sendInChunksdataToSend;
	var iter = sendInChunksiter;

	if(iter == dataToSend.length){
		var dataToSend = [];
		showMessage("Bookmark was successfully saved");
		showLoadingOverlay(false);
		getBms();
		return;
	}

	showLoadingOverlay(true);

	var message = { fun: "addTaxoBmDataChunk", username: escape(currUsername), password: escape(currPassword), name: bookmark, filedata: escape(dataToSend[iter])};
	
	makeAjaxCall(JSON.stringify(message)).then(function(result) 
	{
		if(result == ""){ showMessage("Connection error. Bookmark file was not saved. Please try again"); getBms(); showLoadingOverlay(false); return; }

		var myObj = JSON.parse(result);

		if(myObj.result == "ok"){
			sendInChunksiter = iter + 1;
			sendRestOfData();
		}
	});
}

function getBase64(file) {
  return new Promise((resolve, reject) => {
    var reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = () => {
      var encoded = reader.result;
      resolve(encoded);
    };
    reader.onerror = error => reject(error);
  });
}

function chunkArray(arr,n){
     var chunkLength = Math.max(arr.length/n ,1);
     var chunks = [];
     for (var i = 0; i < n; i++) {
         if(chunkLength*(i+1)<=arr.length)chunks.push(arr.slice(chunkLength*i, chunkLength*(i+1)));
     }
     return chunks; 
 }

function getBookmarkFile(bookmark){
	showLoadingOverlay(true);
	var message = { fun: "getBookmarkFile", username: escape(currUsername), password: escape(currPassword), bookmark: bookmark};
	
	makeAjaxCall(JSON.stringify(message)).then(function(result) 
	{
		if(result == ""){ showMessage("Connection error. Please try again"); showLoadingOverlay(false); return; }

		var myObj = JSON.parse(result);

		if(myObj.result[0][0] == ""){
			showMessage("This bookmark has no file attached")
		}
		else{
			var base64HeadAndBody = myObj.result[0][1].split(";base64,");
			var abc = base64HeadAndBody[1].replace(/-/g,"+");
			var cba = base64HeadAndBody[0] + ";base64," + abc;

			saveAs(cba, myObj.result[0][0]);
		}

		showLoadingOverlay(false);
	});
}

function removeBookmark(bmToDelete){
	showLoadingOverlay(true);
	
	var message = { fun: "removeBookmark", username: escape(currUsername), password: escape(currPassword), name: bmToDelete};
	
	makeAjaxCall(JSON.stringify(message)).then(function(result) 
	{
		if(result == ""){ showMessage("Connection error. Please try again"); showLoadingOverlay(false); return; }

		var myObj = JSON.parse(result);

		showLoadingOverlay(false);

		if(myObj.result == "bookmark_removed"){
			showMessage("Bookmark deleted");
			bmTreeNeedsUpdate = true;
			similarBmsCache = {};
		}
		else{
			showMessage(myObj.result);
		}

		currentDetails = "";
		getBms();
	});
}

function addTag(){
	var bmName = getById("addConToBmInput").value;

	if(!(currBookmarks.indexOf(bmName) > -1)){
		showMessage("This bookmark does not exist");
		return;
	}

	showLoadingOverlay(true);
	
	var message = { fun: "addTaxoTag", username: escape(currUsername), password: escape(currPassword), name: escape(bmName), taxoId: currTaxoId, taxoName: currTaxoName };
	
	makeAjaxCall(JSON.stringify(message)).then(function(result) 
	{
		if(result == ""){ showMessage("Connection error. Please try again"); showLoadingOverlay(false); return; }

		var myObj = JSON.parse(result);

		showLoadingOverlay(false);
		bmTreeNeedsUpdate = true;
		similarBmsCache = {};
		getBms();
		updateNavigation(event,currTaxoId);
		showMenu(0);
	}); 
}
//#endregion 

//#region context
function addNewContext(){
	var conName = getById("newContextInput").value;
	contexts.push([conName,[],[]]);
	updateContext(conName);
}

function updateContext(contextToUpdate){
	var clength = contexts.length;
	var context = undefined;
	for (i = 0; i < clength; i++) {
		if(contexts[i][0] == contextToUpdate){
			context = contexts[i];
		} 
	}

	if(context == undefined){
		return;
	}

	showLoadingOverlay(true);

	var taxoLength = context[1].length;
	var taxos = "";
	for (i = 0; i < taxoLength; i++) {
		if(i == 0){
			taxos = context[1][i][0];
		}
		else{
			taxos = taxos + "," +  context[1][i][0];
		} 
	}

	var enc = window.btoa(JSON.stringify(context[2]));

	var message = { fun: "addContext", username: escape(currUsername), password: escape(currPassword), contextName: context[0], taxoTags: taxos, queries: enc};
	
	makeAjaxCall(JSON.stringify(message)).then(function(result) 
	{
		if(result == ""){ showMessage("Connection error. Please try again"); showLoadingOverlay(false); return; }

		var myObj = JSON.parse(result);

		getContexts(currentContext);
		showMenu(0);
		showLoadingOverlay(false);
	});  
}

function getContexts(contextToShow){
	var message = { fun: "getContexts", username: escape(currUsername), password: escape(currPassword) };
	
	makeAjaxCall(JSON.stringify(message)).then(function(reqResult) 
	{
		if(reqResult == ""){ showMessage("Connection error. Please try again"); showLoadingOverlay(false); return; }

		var myObj = JSON.parse(reqResult);

		var result = myObj.result;
		var myObjLen = result.length;
		contexts = [];
		
		for (i = 0; i < myObjLen; i++) {
			var contextToAdd = [result[i][0][1], result[i][1][1],JSON.parse(window.atob(result[i][2][1]))];
			contexts.push(contextToAdd);
		}

		updateContextDropdown();
		setUpContext(contextToShow);	
	}); 
}

function setUpContext(contextToShow){
	currentContext = contextToShow;
	var myNode = getById("contextSection");
	removeChildren(myNode);

	if(contexts.length > 0){
		var context = contexts[contextToShow];
		
		var card = makeDiv("div", ["w3-card-2","w3-round"], undefined, "5px", darkerShadeColor);
	
		var tableDiv = makeDiv("div", ["w3-round"],undefined,undefined,undefined,"100%")
		tableDiv.style.display = "table";
		card.appendChild(tableDiv);

		var leftCol = makeDiv("div",undefined,undefined,undefined,undefined,"30%")
		leftCol.style.display =  "table-cell";
		tableDiv.appendChild(leftCol);

		var centerCol = makeDiv("div",undefined,undefined,undefined,undefined,"40%")
		centerCol.style.display =  "table-cell";
		tableDiv.appendChild(centerCol);

		var rightCol = makeDiv("div",undefined,undefined,undefined,undefined,"30%")
		rightCol.style.display = "table-cell";
		rightCol.style.textAlign = "right";
		tableDiv.appendChild(rightCol);

		var contextName = makeDiv("h4",["w3-wide","unselectable","w3-text-light-grey"],"0px");
		contextName.appendChild(document.createTextNode(context[0]));
		centerCol.appendChild(contextName);

		var deleteContextBtn = makeButton("Delete", "deleteContext('"+context[0]+"')", buttonColor, "0px 6px 4px 0px");
		deleteContextBtn.style.padding = "4px 7px";
		rightCol.appendChild(deleteContextBtn);

		var conceptsText = makeDiv("h5",["w3-text-light-grey","unselectable","w3-text-light-grey"],"0px");
		conceptsText.appendChild(document.createTextNode("Concepts"));
		card.appendChild(conceptsText);

		for (var i = 0; i < context[1].length; i++) { 
			var cardForTag = makeDiv("div", ["w3-card-2","w3-round", "parent", "testhoverGray"],"10px", "3px", buttonColor);
			var hoverArea = makeDiv("div", ["w3-center","w3-round","tooltip","testhover"], "0px", undefined, backgroundColor, "10%");
			var textDiv = makeDiv("header", ["w3-text-light-grey"], "0px 0px 5px 0px", "0px 5px", undefined, "90%");
			cardForTag.appendChild(hoverArea);
			cardForTag.appendChild(textDiv);
			cardForTag.appendChild(makeDiv("div", undefined,undefined,undefined,undefined, "10%"));

			var tmpTitle = context[1][i][1];
			var nodeTmp = document.createTextNode(tmpTitle.replace(/,/g, ", "));

			var tmp = tmpTitle.split(",");
			tmp = "addToSearchField('"+tmp[0]+"','"+context[1][i][0]+"')";
			cardForTag.setAttribute("onclick",tmp);

			var par = makeDiv("div", ["unselectable", "w3-text-light-grey"]);
			par.appendChild(nodeTmp);
			textDiv.appendChild(par);

			var tooltiptextDiv = makeDiv("div", ["tooltiptext"]);;
			hoverArea.appendChild(tooltiptextDiv);

			var butPara = document.createElement("div");
			butPara.appendChild(makeButton("Open", "updateNavigation(event,'"+context[1][i][0]+"')", greenAccentColor, "5px"));
			butPara.appendChild(makeButton("Remove", "removeConceptFromContext(event,'"+context[1][i][0]+"')", buttonColor, "5px"));

			tooltiptextDiv.appendChild(butPara);

			card.appendChild(cardForTag);
		}

		var queriesText = makeDiv("div", ["unselectable", "w3-text-light-grey"]);
		queriesText.appendChild(document.createTextNode("Queries"));
		card.appendChild(queriesText);

		for (var i = 0; i < context[2].length; i++) { 
			var cardForQuery = makeDiv("div", ["w3-card-2","w3-round", "parent", "testhoverGray"], "10px", undefined, backgroundColor);
			cardForQuery.setAttribute("onclick","updateSearchFromContextQuery('"+context[2][i][1]+"')");
			
			var hoverArea = makeDiv("div", ["w3-center","w3-round","tooltip","testhover"], "5px", undefined, buttonColor, "10%");
			var textDiv = makeDiv("header", ["w3-text-light-grey"], "0px 0px 5px 0px", "0px", undefined, "90%");
			cardForQuery.appendChild(hoverArea);
			cardForQuery.appendChild(textDiv);
			cardForQuery.appendChild(makeDiv("div", undefined,undefined,undefined,undefined, "10%"));

			var queryName = makeDiv("div", ["unselectable", "w3-text-light-grey"], "0px");
			queryName.appendChild(document.createTextNode(context[2][i][0]));
			queryName.style.fontWeight = "bold";
			textDiv.appendChild(queryName);

			var query = makeDiv("div", ["unselectable", "w3-text-light-grey"]);
			query.appendChild(document.createTextNode(context[2][i][1]));
			textDiv.appendChild(query);

			var tooltiptextDiv= makeDiv("div", ["tooltiptext"]);
			hoverArea.appendChild(tooltiptextDiv);

			var butPara = document.createElement("div");
			butPara.appendChild(makeButton("Update", "updateQueryInContext(event,'"+context[2][i][0]+"')", greenAccentColor, "5px"));
			butPara.appendChild(makeButton("Delete", "deleteQueryFromContext(event,'"+context[2][i][0]+"')", buttonColor, "5px"));

			tooltiptextDiv.appendChild(butPara);

			card.appendChild(cardForQuery);
		}

		myNode.appendChild(card);
	}
}

function updateSearchFromContextQuery(query){
	getById("BmSearchInput").value = query;
}

function addToSearchField(text,id){
	var searchField = getById("BmSearchInput").value;

	if(searchField == ""){
		getById("BmSearchInput").value = "["+text+","+id+"]";
	}
	else{
		getById("BmSearchInput").value += " " + "["+text+","+id+"]";
	}
}

function updateContextDropdown(){
	var dropdown = getById("contextDropdown");
	removeChildren(dropdown);

	for(var i = 0; i < contexts.length; i++)
	{
		var opt = document.createElement("option");
		opt.value= i;
		opt.textContent = contexts[i][0];
		dropdown.appendChild(opt);
	}
}

function selectContext(){
	setUpContext(getById("contextDropdown").value);
}

function addTaxoTagToContext(ev,taxoId,taxoName){
	if(contexts.length == 0){
		return;
	}
	contexts[currentContext][1].push([taxoId, taxoName]);
	updateContext(contexts[currentContext][0]);

	if(ev != undefined){
		ev.stopPropagation();
	}
}

function saveQueryToContext(){
	if(contexts.length == 0){
		return;
	}

	var queryName = getById("newQueryNameInput").value;
	var query = getById("BmSearchInput").value;

	contexts[currentContext][2].push([queryName, query]);
	updateContext(contexts[currentContext][0]);
}

function updateQueryInContext(ev, queryName){
	if(ev != undefined){
		ev.stopPropagation();
	}
	
	if(contexts.length == 0){
		return;
	}

	var query = getById("BmSearchInput").value;

	for(var i = 0; i < contexts[currentContext][2].length; i++ ){
		if(contexts[currentContext][2][i][0] == queryName){
			contexts[currentContext][2][i] = [queryName, query];
			updateContext(contexts[currentContext][0]);
			break;
		}
	}
}

function deleteQueryFromContext(ev,queryName){
	if(ev != undefined){
		ev.stopPropagation();
	}
	
	if(contexts.length == 0){
		return;
	}

	var newListOfQueries = [];
	for(var i = 0; i < contexts[currentContext][2].length; i++ ){
		if(contexts[currentContext][2][i][0] != queryName){
			newListOfQueries.push(contexts[currentContext][2][i]);
		}
	}

	contexts[currentContext][2] = newListOfQueries;
	updateContext(contexts[currentContext][0]);
}

function removeConceptFromContext(ev, concept){
	if(ev != undefined){
		ev.stopPropagation();
	}
	
	if(contexts.length == 0){
		return;
	}

	var newListOfConcepts = [];
	for(var i = 0; i < contexts[currentContext][1].length; i++ ){
		if(contexts[currentContext][1][i][0] != concept){
			newListOfConcepts.push(contexts[currentContext][1][i]);
		}
	}

	contexts[currentContext][1] = newListOfConcepts;
	updateContext(contexts[currentContext][0]);
}

function deleteContext(contextToUpdate)
{
	var clength = contexts.length;
	var context = undefined;
	for (i = 0; i < clength; i++) {
		if(contexts[i][0] == contextToUpdate){
			context = contexts[i];
		} 
	}

	if(context == undefined){
		return;
	}

	showLoadingOverlay(true);

	var message = { fun: "removeContext", username: escape(currUsername), password: escape(currPassword), contextName: context[0]};
	
	var messageJSON = JSON.stringify(message);
	
	makeAjaxCall(JSON.stringify(message)).then(function(reqResult) 
	{
		if(reqResult == ""){ showMessage("Connection error. Please try again"); showLoadingOverlay(false); return; }

		getContexts(currentContext);
		showLoadingOverlay(false);	
	}); 
}
//#endregion

//#region tree
function showTreeView(){
	if(bmTreeNeedsUpdate == false){
		return;
	}

	showLoadingOverlay(true);

	var message = { fun: "getBookmarkTree", username: escape(currUsername), password: escape(currPassword)};

	makeAjaxCall(JSON.stringify(message)).then(function(result) 
	{
		if(result == ""){ showMessage("Connection error. Please try again"); showLoadingOverlay(false); return; }

		var myObj = JSON.parse(result);
		
		showLoadingOverlay(false);
		populateTreeView(myObj.result);

		bmTreeNeedsUpdate = false;
	});
}

function populateTreeView(results){
	var myNode = getById("myUL");
	removeChildren(myNode);

	var resultsLength = 0;

	if(results != undefined){
		resultsLength =  results.length;
	}

	if(resultsLength > 0){	
		populateTreeViewHelper(myNode, results)
		var toggler = document.getElementsByClassName("caret");
		var i;

		for (i = 0; i < toggler.length; i++) {
		toggler[i].addEventListener("click", function() {
			this.parentElement.querySelector(".nested").classList.toggle("active");
			this.classList.toggle("caret-down");
		});
		}
	}	
}

function populateTreeViewHelper(parent, children){
	var card = makeDiv("li",["w3-round"],"1px 12px","1px 3px",darkerShadeColor);
	var header = makeDiv("span",["unselectable","caret","w3-text-light-grey"],undefined,"2px 5px",darkerShadeColor);
	header.appendChild(document.createTextNode(children[0][1].split(",")[0]));
	card.appendChild(header);
	parent.appendChild(card);

	var card2 = makeDiv("ul",["w3-round","nested"],undefined,"1px",darkerShadeColor);
	card.appendChild(card2);

	for (var i = 0; i < children[0][2].length; i++) { 
		var card3 = makeDiv("li",["w3-round","w3-card-2","testhover"],"5px 12px","1px 3px",darkestShadeColor);
		var header2 = makeDiv("header",["unselectable","w3-text-light-grey"],undefined,"2px 5px");
		header2.appendChild(document.createTextNode(children[0][2][i]));
		card3.appendChild(header2);
		card3.setAttribute("onclick","showBmDetails('"+children[0][2][i]+"',true)");
		card2.appendChild(card3);
	}

	for (var i = 1; i < children.length; i++) { 
		populateTreeViewHelper(card2, children[i])
	}
}
//#endregion

//#region utility tools
function makeAjaxCall(messageJSON){
	var promiseObj = new Promise(function(resolve, reject){
		var xhttp = new XMLHttpRequest();
		xhttp.onreadystatechange = function() {
		if (this.readyState == 4) {
			if(this.status == 200){
				resolve(this.responseText)
			}
		}
		};
		xhttp.open("POST", serverAddress, true);
		xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
		xhttp.send("dataToForward="+messageJSON);  
	 });
	 
 	return promiseObj;
}

function reloadPage(){
	location.reload();
}

function getById(elementName){
	return document.getElementById(elementName);
}

function removeChildren(node){
	while (node.firstChild) {
		node.removeChild(node.firstChild);
	}
}

function makeDiv(divType, additionalClasses = undefined ,margin = undefined, padding = undefined, color = undefined, width = undefined){
	var toRet = document.createElement(divType);

	if(margin != undefined){
		toRet.style.margin = margin;
	}

	if(padding != undefined){
		toRet.style.padding = padding;
	}

	if(color != undefined){
		toRet.style.background = color;
	}

	if(width != undefined){
		toRet.style.width = width;
	}

	if(additionalClasses != undefined){
		additionalClasses.forEach(element => {
			toRet.classList.add(element);
		});
	}

	return toRet;
}

function makeButton(buttonText, onClickAction, color, margin = undefined){
	var button = document.createElement("button");
	button.appendChild(document.createTextNode(buttonText));
	button.classList.add("w3-button");
	button.classList.add("w3-round");
	button.classList.add("w3-text-light-grey");
	button.style.background = color;
	button.setAttribute("onclick",onClickAction);

	if(margin != undefined){
		button.style.margin = margin;
	}

	return button;
}

function autocomplete(inp, arr, enterKeyCallback) {
  var currentFocus;
  var SuggestionCon;
  inp.addEventListener("input", function(e) {
      var a, b, i, val = this.value;
      closeAllLists();
      if (!val) { return false;}
      currentFocus = -1;
      a = document.createElement("div");
	  SuggestionCon = this.parentNode;
      a.setAttribute("id", this.id + "autocomplete-list");
      a.setAttribute("class", "autocomplete-items");
      this.parentNode.appendChild(a);
	  if(val.length > 2)
	  {
		  for (i = 0; i < arr.length; i++) {
			if (arr[i].substr(0, val.length).toUpperCase() == val.toUpperCase()) {
			  b = document.createElement("div");
			  b.style.background = darkestShadeColor;
			  b.style.color = blueAccentColor;
			  b.style.borderColor = buttonColor;
			  b.innerHTML = "<strong>" + arr[i].substr(0, val.length) + "</strong>";
			  b.innerHTML += arr[i].substr(val.length);
			  b.innerHTML += "<input type='hidden' value='" + arr[i] + "'>";
			  b.addEventListener("click", function(e) {
				  inp.value = this.getElementsByTagName("input")[0].value;
				  closeAllLists();
			  });
			  a.appendChild(b);
			  if(a.childElementCount >= 10)
			  {
				break;
			  }
			}
		  }
	  }
  });

  inp.addEventListener("keydown", function(e) {
	  if(getById("overlayDiv").hidden == true){
		var x = getById(this.id + "autocomplete-list");
		if (x) x = x.getElementsByTagName("div");
		if (e.keyCode == 40) {
			currentFocus++;
			addActive(x);
		} else if (e.keyCode == 38) { 
			currentFocus--;
			addActive(x);
		} else if (e.keyCode == 13) {
			e.preventDefault();
			if(currentFocus > -1 && SuggestionCon.childElementCount == 1 ){
				enterKeyCallback();
				closeAllLists();
			}
			else if (currentFocus > -1) {
			if (x) x[currentFocus].click();
			}
			else if(currentFocus == -1){
				enterKeyCallback();
				closeAllLists();
			}
      	}
	  }
	  else{
		e.preventDefault();
	  }


  });
  function addActive(x) {
    if (!x) return false;
    removeActive(x);
    if (currentFocus >= x.length) currentFocus = 0;
    if (currentFocus < 0) currentFocus = (x.length - 1);
    x[currentFocus].classList.add("autocomplete-active");
  }
  function removeActive(x) {
    for (var i = 0; i < x.length; i++) {
      x[i].classList.remove("autocomplete-active");
    }
  }
  function closeAllLists(elmnt) {
    var x = document.getElementsByClassName("autocomplete-items");
    for (var i = 0; i < x.length; i++) {
      if (elmnt != x[i] && elmnt != inp) {
        x[i].parentNode.removeChild(x[i]);
      }
    }
  }
  document.addEventListener("click", function (e) {
      closeAllLists(e.target);
      });
}
//#endregion
</script>
</body>
</html>
